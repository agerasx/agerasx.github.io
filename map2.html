<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Malyshev</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.14/"></script>

    <script>
      require(["esri/Map",
        "esri/views/MapView",
        "esri/layers/GeoJSONLayer",
        "esri/layers/FeatureLayer",
        "esri/widgets/LayerList",
        "esri/tasks/support/Query",
        "esri/request",
        "esri/renderers/HeatmapRenderer"],
              function(Map, MapView, GeoJSONLayer, FeatureLayer, LayerList, Query, esriRequest, HeatmapRenderer) {

        //Создать стиль Popup's
        const template = {
            title: "Населенный пункт",
            content: "<p> <b> Регион: </b>{A_RGN} </p>  <p> <b> Район: </b> {A_DSTRCT} </p> <b>Нас. пункт: </b>{NAME}"
            //     ,fieldInfos: [
            //     {
            //         fieldName: "time",
            //         format: {
            //             dateFormat: "short-date-short-time"
            //         }
            //     }
            // ]
        };

          //Создать стиль отображения точек по населению
          // const renderer = {
          //     type: "simple",
          //     symbol: {
          //         type: "simple-marker",
          //         color: "orange",
          //         outline: {
          //             color: "white"
          //         }
          //     },
          //     visualVariables: [
          //         {
          //             type: "size",
          //             field: "POPULATION",
          //             stops: [
          //                 {
          //                     value: 10000,
          //                     size: "4px"
          //                 },
          //                 {
          //                     value: 100000,
          //                     size: "10px"
          //                 }
          //             ]
          //         }
          //     ]
          // };

        const renderer = {
              type: "simple",
              symbol: {
                  type: "simple-marker",
                  size: "2px",
                  color: "orange",
                  outline: {
                      color: "white"
                  }
              },
              visualVariables: [
                  {
                      type: "size",
                      field: "Cloud05",
                      minValue: 0,
                      stops: [
                          {
                              value: 6,
                              size: "4px"
                          },
                          {
                              value: 7,
                              size: "10px"
                          },
                        {
                          value: 0,
                          size: "1px"
                        }
                      ]
                  }
              ]
          };

        //Создать стиль отображения полигонов
        const renderer2 = {
          type: "simple",
          symbol: {
            type: "simple-fill",
            outline: {
              color: "lightgray",
              width: 0.5
            }
          }
        };

        //Загрузка слоев с применением стилей
        const citylayer = new GeoJSONLayer({
          url: "https://agerasx.github.io/city.geojson",
          title: "City Bashkortostan",
          popupTemplate: template,
          renderer: renderer
        });

        const raynlayer = new GeoJSONLayer({
            url: "https://agerasx.github.io/rayn.geojson",
            title: "Rayons",
            renderer: renderer2
        });

        //Прозрачность слоя 50%
        raynlayer.opacity = 0.5;

        //Пробую загрузить данные
        // const data = new FeatureLayer({
        //   url: "https://agerasx.github.io/data/data.json"
        // });
        function loadLayerWithData(url) {
          Promise.all([
            esriRequest("https://agerasx.github.io/city.geojson", {responseType: "json"}),
            esriRequest(url, {responseType: "json"}),
          ]).then(function(responses){
            var geoJson = responses[0].data;
            var jsonData = responses[1].data;
            const features = geoJson.features;
            jsonData.forEach((obj) => {
              features.filter(f => {
                return f.properties["A_DSTRCT"] === obj["Area"]
                        && f.properties["A_RGN"] === obj["Region"]
                        && f.properties["NAME"] === obj["Locality"]
              }).forEach(f => {
                f.properties = {...obj, ...f.properties};
              })
            });
            const blob = new Blob([JSON.stringify(geoJson)], {type: "application/json"});
            const url  = URL.createObjectURL(blob);
            const layer = new GeoJSONLayer({ url : url, renderer: renderer});
            map.add(layer);
          });
        }
        loadLayerWithData("https://agerasx.github.io/data/data280420.json")


        //Загрузка карты-подложки
        var map = new Map({
          basemap: "topo",
          layers: [raynlayer]
        });

        //Настройка отображения стартового вида
        var view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 7,
          center: [56, 54] // longitude, latitude
        });





        //Добавление виджета слоев
        view.when(function() {
          var layerList = new LayerList({
            view: view
          });
          view.ui.add(layerList, "top-right");
        });
	  });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>